"use strict";var $=Object.create;var N=Object.defineProperty,Y=Object.defineProperties,j=Object.getOwnPropertyDescriptor,z=Object.getOwnPropertyDescriptors,J=Object.getOwnPropertyNames,G=Object.getOwnPropertySymbols,W=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var I=(t,e,r)=>e in t?N(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,B=(t,e)=>{for(var r in e||(e={}))O.call(e,r)&&I(t,r,e[r]);if(G)for(var r of G(e))Q.call(e,r)&&I(t,r,e[r]);return t},L=(t,e)=>Y(t,z(e)),c=(t,e)=>N(t,"name",{value:e,configurable:!0});var Z=(t,e)=>{for(var r in e)N(t,r,{get:e[r],enumerable:!0})},M=(t,e,r,m)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of J(e))!O.call(t,a)&&a!==r&&N(t,a,{get:()=>e[a],enumerable:!(m=j(e,a))||m.enumerable});return t};var F=(t,e,r)=>(r=t!=null?$(W(t)):{},M(e||!t||!t.__esModule?N(r,"default",{value:t,enumerable:!0}):r,t)),K=t=>M(N({},"__esModule",{value:!0}),t);var i=(t,e,r)=>new Promise((m,a)=>{var b=d=>{try{s(r.next(d))}catch(p){a(p)}},A=d=>{try{s(r.throw(d))}catch(p){a(p)}},s=d=>d.done?m(d.value):Promise.resolve(d.value).then(b,A);s((r=r.apply(t,e)).next())});var ee={};Z(ee,{CronJobGamer:()=>X});module.exports=K(ee);var x=F(require("node-cron")),R=F(require("moment"));var P=require("@prisma/client"),o=new P.PrismaClient;o.$disconnect();function C(){return i(this,null,function*(){let t=yield o.game.findFirst({orderBy:{created_at:"desc"}}),e=1;return(t==null?void 0:t.match_id)==null||(e=(t==null?void 0:t.match_id)+1),e})}c(C,"returnLastIdTableGames");function H(){let t=[];for(let m=1;m<=60;m++)t.push(m);for(let m=t.length-1;m>0;m--){let a=Math.floor(Math.random()*(m+1));[t[m],t[a]]=[t[a],t[m]]}return t.slice(0,6).sort((m,a)=>m-a)}c(H,"generateUniqueNumbers");function U(t,e){return i(this,null,function*(){let r=yield o.award.findFirst({where:{gamer_ref:e}});return r!=null&&r.id?yield o.game.create({data:{numbers:t,match_id:e}}):yield o.game.findFirst({where:{match_id:e-1}})})}c(U,"insertValueTableGame");var g,k=(g=class{static _HANDLE(e,r){return i(this,null,function*(){return yield e.map(a=>i(this,null,function*(){let A=a.numbers.split(",").map(s=>parseInt(s)).filter(s=>r==s);if(A.length!=0){let s=yield o.bet.findUnique({where:{id:a.id}}),d=s!=null&&s.hits_round?(s==null?void 0:s.hits_round)+1:1,p=s!=null&&s.namber_round?(s==null?void 0:s.namber_round)+","+A.toString():A.toString();yield o.bet.update({where:{id:a.id},data:{hits_round:d,namber_round:p}})}return a}))})}},c(g,"updateEveryRoundOfTheResult"),g);var S,q=(S=class{static buscarValoresDosPremios(){return i(this,null,function*(){return yield o.award.findFirst({select:{subtract_premiums:!0,seine:!0,corner:!0,block:!0},orderBy:{created_at:"desc"},take:1})})}},c(S,"BuscarUltimoValorPremio"),S);console.log("CRONJOBGAMER::INICIADO");var w,X=(w=class{static startGamer(e){return i(this,null,function*(){return x.default.schedule("*/3 * * * *",()=>i(this,null,function*(){console.log("minut"),e.emit("__CLEAN__");let r=String(yield this.FN_GET_NUMBER_GAME()),m=Number(yield this.FN_VERIFY_LAST_INSERT_TABLE_GAMER()),a=yield U(r,m),b=String(a==null?void 0:a.match_id);yield o.award.update({where:{id:Number(b)},data:{is_completed:"REFUSES_VALUES"}}).then(f=>{console.log("UPDATE: ",f)});let A=a==null?void 0:a.created_at,s=(0,R.default)(A).format("HH:mm:ss"),d=(0,R.default)(A).add(2,"minutes").format("HH:mm:ss");e.emit("relogio",{atual:s,atualizda:d}),e.emit("number::aposta",b);let p=r.split(",").map(f=>Number(f)),y=yield o.bet.findMany({where:{awarded:!1,number_game_result:b,status:"IN_PROCESSING"}});D(0);function D(f){return i(this,null,function*(){let l;if(f>=p.length){console.log(new Date().toTimeString()),clearTimeout(l),yield V(),console.log(new Date().toTimeString()),setTimeout(()=>{},2e3);try{new Promise(function(n,u){return i(this,null,function*(){let E=yield o.$queryRaw`CALL PROCEDURE_BUSCAS_QUANTIDADE_GANHADORES(${b})`;console.log("NEW PROMISE: ",E),yield o.$disconnect(),n(E)})}).then(()=>{setTimeout(()=>i(this,null,function*(){let n=yield o.award.findFirst({where:{gamer_ref:Number(b)},orderBy:{created_at:"desc"}}),u=Number(n==null?void 0:n.subtract_premiums),E=(u>0?u:50).toFixed(2),v=Number(n==null?void 0:n.subtract_premiums)!=0?Number(n==null?void 0:n.subtract_premiums):50;try{let T=yield o.award.create({data:{total_prizes:E,subtract_premiums:E,seine:Number(E)*75/100,corner:Number(E)*15/100,block:Number(E)*10/100,gamer_ref:(n==null?void 0:n.gamer_ref)+1,is_completed:"IN_PROCESSING",home_deposit:v}});console.log("INSERT: ",T);let _=yield q.buscarValoresDosPremios();e.emit("/BUSCAR_VALORES_APOSTA",{subtract_premiums:_==null?void 0:_.subtract_premiums,seine:_==null?void 0:_.seine,corner:_==null?void 0:_.corner,block:_==null?void 0:_.block})}catch(T){console.log(T)}console.log("CALCULO REALIZADO!")}),1e4)})}catch(n){console.log(n)}return}l=setTimeout(()=>i(this,null,function*(){e.emit("gamer:total",p[f]),D(f+1)}),1e4),yield k._HANDLE(y,p[f]);let h=yield o.bet.findMany({where:{number_game_result:String(b),AND:{}},take:15,orderBy:{hits_round:"desc"},include:{establishment:{select:{name:!0}}}});if(h.length>0){console.log("Entrar");let n=h.map(u=>({id:u.id,namber_bet:u.namber_bet,name:u.establishment.name,namber_round:u.namber_round?u.namber_round.split(","):[]}));setTimeout(()=>e.emit("_GANHADORES_",{_GANHADORES_:n,info:!1}),1e3),console.log("Sair")}})}c(D,"processArray");function V(){return i(this,null,function*(){y.map(l=>{let h=l.numbers.split(",").map(u=>parseInt(u)),n=h.filter(u=>p.includes(u));return L(B({},l),{hits:n.length,awarded:n.length>=4,numbersArray:h,intersection:n})}).forEach((l,h)=>i(this,null,function*(){yield o.bet.update({where:{id:l.id},data:{hits:l.hits,awarded:!!l.awarded,status:"FINISHED"}})})),setTimeout(()=>o.bet.findMany({where:{number_game_result:{equals:String(b)},AND:{awarded:{equals:!0}}},take:15,orderBy:{hits:"desc"},include:{establishment:{select:{name:!0}}}}).then(l=>{if(l.length>0){let h=l.map(n=>({id:n.id,namber_bet:n.namber_bet,name:n.establishment.name,namber_round:n.namber_round?n.namber_round.split(","):[]}));console.log("setTimeout init",new Date().toTimeString()),e.emit("_GANHADORES_",{_GANHADORES_:h,info:!0}),console.log("setTimeout fim",new Date().toTimeString())}}),2e3)})}c(V,"calculaApostas")}))})}static FN_GET_NUMBER_GAME(){return i(this,null,function*(){return(yield H()).toString().slice(",")})}static FN_VERIFY_LAST_INSERT_TABLE_GAMER(){return i(this,null,function*(){return yield C()})}},c(w,"CronJobGamer"),w);0&&(module.exports={CronJobGamer});
