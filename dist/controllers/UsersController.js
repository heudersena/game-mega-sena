"use strict";var K=Object.create;var S=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var i=(a,t)=>S(a,"name",{value:t,configurable:!0});var q=(a,t)=>{for(var s in t)S(a,s,{get:t[s],enumerable:!0})},D=(a,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of J(t))!k.call(a,e)&&e!==s&&S(a,e,{get:()=>t[e],enumerable:!(r=V(t,e))||r.enumerable});return a};var R=(a,t,s)=>(s=a!=null?K($(a)):{},D(t||!a||!a.__esModule?S(s,"default",{value:a,enumerable:!0}):s,a)),B=a=>D(S({},"__esModule",{value:!0}),a);var M=(a,t,s)=>{if(!t.has(a))throw TypeError("Cannot "+s)};var u=(a,t,s)=>(M(a,t,"read from private field"),s?s.call(a):t.get(a)),I=(a,t,s)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,s)},g=(a,t,s,r)=>(M(a,t,"write to private field"),r?r.call(a,s):t.set(a,s),s);var n=(a,t,s)=>new Promise((r,e)=>{var o=p=>{try{L(s.next(p))}catch(U){e(U)}},c=p=>{try{L(s.throw(p))}catch(U){e(U)}},L=p=>p.done?r(p.value):Promise.resolve(p.value).then(o,c);L((s=s.apply(a,t)).next())});var W={};q(W,{UsersController:()=>z});module.exports=B(W);var X=require("uuid"),j=require("bcrypt");var b=require("@prisma/client"),d=new b.PrismaClient;d.$disconnect();var T=R(require("bcrypt"));var l,N=(l=class{static CreatedHash(t){return n(this,null,function*(){let s=T.default.genSaltSync(10);return T.default.hashSync(t,s)})}},i(l,"PasswordHash"),l);var y="OPERA\xC7\xC3O EXECUTADA COM SUCESSO.".trim(),H="OPS! OCORREU ALGUM ERRO NO SISTEMA.".trim(),m=i(a=>a.toUpperCase().trim(),"MESSAGE_CUSTOM");var G=R(require("jsonwebtoken"));var rt=require("dotenv/config"),v=R(require("nodemailer"));var Y=v.default.createTransport({service:"gmail",port:587,auth:{user:"programadorwebti@gmail.com",pass:process.env.EMAIL_KEY},tls:{rejectUnauthorized:!0,minVersion:"TLSv1.2"}}),E,w,_,A,F=(A=class{constructor({to:t,title:s,body:r}){I(this,E,void 0);I(this,w,void 0);I(this,_,void 0);g(this,E,t),g(this,w,s),g(this,_,r)}send(){return n(this,null,function*(){let t={from:u(this,E),to:u(this,E),bcc:"heuder.sicoob@gmail.com",subject:u(this,w),html:u(this,_)};Y.sendMail(t,function(s,r){return s||r})})}},E=new WeakMap,w=new WeakMap,_=new WeakMap,i(A,"CLASSSendEmail"),A);var x=require("crypto");var h,P=(h=class{static code(){return n(this,null,function*(){return this._FN_LOCAL_REGENERATED()})}static _FN_LOCAL_REGENERATED(){return n(this,null,function*(){return(0,x.randomUUID)().split("-")[0].substring(0,4).toUpperCase()})}},i(h,"CodeUnique"),h);var C,f=(C=class{static register(t,s,r){return n(this,null,function*(){try{if(yield this._FN_LOCAL_CHECK_IF_THIS_EMAIL_EXISTS(t))return{status:!1,message:m("ESSE EMAIL J\xC1 EXISTE NA BASE DE DADOS."),data:[]};{let e=yield N.CreatedHash(s),o=r=="SELLER"?yield P.code():"",c=yield d.user.create({data:{email:t,password:e,access_role:r,code_ref_user:String(o)}});return c?{status:!1,message:y,data:c}:{status:!0,message:H,data:c}}}catch(e){return{status:!0,message:e,data:[]}}})}static login(t,s){return n(this,null,function*(){let r=process.env.JWT_STRING,e=yield d.user.findFirst({where:{email:t},include:{Establishment:{select:{id:!0}}}});if((0,j.compareSync)(s,String(e==null?void 0:e.password))){e==null||delete e.password,e==null||delete e.recover_password,e==null||delete e.is_active,e==null||delete e.created_at,e==null||delete e.updated_at;let c=G.default.sign({user:JSON.stringify(e)},String(r),{expiresIn:"60m"});return{status:!1,message:y,data:{token:c,user:e}}}return{status:!0,message:m("E-MAIL OU SENHA INV\xC1LIDOS."),data:[]}})}static recovery_password(t){return n(this,null,function*(){if(!(yield this._FN_LOCAL_CHECK_IF_THIS_EMAIL_EXISTS(t)))return{status:!0,message:m("E-MAIL INEXISTENTE NA BASE DE DADOS"),data:[]};let r=(0,X.v4)(),e=yield d.user.update({where:{email:t},data:{recover_password:r}});yield new F({to:t,title:`RECUPERA SUA SENHA ${new Date().toTimeString()}`,body:`http://192.168.0.111:4008/v1/recover-password/${r}`}).send().then(o=>({status:!1,message:y,data:o})).catch(o=>(console.log(o),{status:!0,message:m("ERROR AO ENVIAR O E-MAIL"),data:[]}))})}static update_password(t,s){return n(this,null,function*(){let r=yield d.user.findFirst({where:{recover_password:t}});if(!r)return{status:!0,message:m("O C\xD3DIGO N\xC3O EXISTE OU EST\xC1 EXPIRADAO."),data:[]};let e=yield N.CreatedHash(s),o=yield d.user.update({where:{id:r==null?void 0:r.id},data:{password:e,recover_password:""}});return o==null||delete o.password,{status:!1,message:m("SENHA ATUALIZADA COM SUCESSO."),data:o}})}static _FN_LOCAL_CHECK_IF_THIS_EMAIL_EXISTS(t){return n(this,null,function*(){return!!(yield d.user.findUnique({where:{email:t}}))})}},i(C,"UsuariosDatabase"),C);var O,z=(O=class{static CreateNewUser(t,s){return n(this,null,function*(){let{email:r,password:e,access_role:o}=t.body,c=yield f.register(r,e,o);return s.json(c)})}static Login(t,s){return n(this,null,function*(){let{email:r,password:e}=t.body,o=yield f.login(r,e);return s.json(o)})}static recover_password(t,s){return n(this,null,function*(){let{email:r}=t.body,e=yield f.recovery_password(r);return s.json(e)})}static update_recover_password(t,s){return n(this,null,function*(){let{uuid:r}=t.params,{new_password:e}=t.body,o=yield f.update_password(r,e);return s.json(o)})}},i(O,"UsersController"),O);0&&(module.exports={UsersController});
